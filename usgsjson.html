<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
  <script src="http://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/heatmap.js"></script>
  <script src="https://code.highcharts.com/highcharts-more.js"></script>
  <script src="http://code.highcharts.com/modules/exporting.js"></script>
  <script src="http://highcharts.github.io/export-csv/export-csv.js"></script>
  <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
  <script src="https://rawgithub.com/highslide-software/draggable-points/master/draggable-points.js"></script>

  <script src="moment.js"></script>
  <script src="underscore.js"></script>
  <script src="clipboard.js"></script>


  <title>NWS JS Graphing Example</title>
</head>
<body>
  <h1>USGS Water Services AJAX Example</h1>
  <table>
    <tr>
          <td>
        <table width="100%" border="0">
              <tr>
                   <td><label for="site"><strong>NWS Id No. </strong></label><input type="text" id="site" value ="lirv2" size="8" maxlength="15" /></td>
               </tr>
               <tr>
                  <td><label for="watershedArea"><strong>Area </strong></label><input id="watershedArea" size="7" readonly="readonly" />mi<sup>2</sup></td>
                </tr>
            </table>
      </td>
  </tr>
  </table>
  <form id="form1" method="post" action="">

      <p>
            <input type="button" name="query" id="query" value="Get Latest Streamflow" />

      </p>
  </form>


<table>
    <tr>
        <td>
            Graph Options:
            <input type="checkbox" id="dischargeAxis" style="padding-left:20px" >Log Scale
            <input type="checkbox" id="addFFlines" style="padding-left:20px" checked >2016 Flood Frequency
            <input type="checkbox" id="addFFlines2003" style="padding-left:20px">2003 Flood Frequency</br>
            Graph Functions:
            <input type="radio" name="Qfunction" value = "zoom" checked>Zoom
            <input type="radio" name="Qfunction" value = "base">Base Flow Calc
            <input type="radio" name="Qfunction" value = "shift">Shift Data<br>

            USGS Data:  <input type="checkbox" id ="getDv"> Daily
            <input type="checkbox" id="getIv" checked> Instantaneous<br>
            Start Date:<input type="text" id="dischargeStart" length=10>
            End Date:<input type="text" id="dischargeEnd" length=10>
            <input type="button" id="loadQ" value="Load Custom Range"> <!-- or <input type="button" id="loadAnnual" value="Current Year"> --> or <input type="button" id="zoomToStage" value="Zoom to Stage Graph"></br>
            Comparison:<input type="text" id="comparisonSite" length=20>
            <input type="button" id="loadComparison" value="Load Comparison Site or Year"></br>
            <div id="dischargegraph" style="width: 800px; height: 500px; padding-left:20px"></div>
        </td>
        <td>
            <input type="checkbox" id="ratingLog" style="padding-left:20px" >Log Scale
            <input type="checkbox" id="showFloodStagesRating" checked>Show Flood Stages<br>
            <div id="ratinggraph" style="width: 800px; height: 550px; margin: 0 auto"></div>
        </td>

    </tr>
    <tr>
        <td>
            Drag Box:<input type="radio" name="stageDrag" value="zoom" checked>Zoom
            <input type="radio" name="stageDrag" value="missing" >Set Missing</br>
            <input type="checkbox" id="showFloodStages" checked>Show Flood Stages<br>
            <input type="button" id="shefEncodeForecast" value="Shef Encode Forecast">
            <input type="button" id="shefEncodeObserved" value="Shef Encode Missing Obs">
            <div id="stagegraph" style="width: 700px; height: 550px; margin: 0 auto"></div>
            <button class="btn" data-clipboard-target="#shefText">Copy shef to Clipboard</button>
            <div id='shefText'></div>
        </td>
        <td style="vertical-align: top;">
            <div id="heatMapQ" style="width: 700px; height: 550px; margin: 0 auto;"></div>
        </td>
    </tr>
    <tr>
        <td colspan = "2">
            <div id="annualDischarge" style="width: 1000px; height: 750px; margin: 0 auto"></div>
        </td>
    <tr>

</table>
<div id='stats'></div>

<script type="text/javascript">

//Global Vars


var AHPSjson = {};    //GLOBAL AHPS JSON DATA BY SITE  AHPSjson[nwslid];
var FIPSCODES;
var NWS;
var state;   //need to get rid of this one.
new Clipboard('.btn');


String.prototype.capitalize = function() {
    return this.charAt(0).toUpperCase() + this.slice(1);
}

///////////////////////////////////
//  shef Encode Data
///////////////////////////////////

function shefEncode(dataSet,onlyMissing = false){

    var nwsLid = dataSet.options.NWSid;
    var data = dataSet.data;

    var pedts = dataSet.options.pedts;

    var shefData = '';
    for(i=0;i<data.length-1;i++){
        var shefMessage = '';

        if(typeof data[i] == 'undefined') continue;

        var date = moment.utc(data[i].x).format("YYMMDD");
        var time = moment.utc(data[i].x).format("HHmm");
        var dc = moment.utc().format('YYMMDDHHmm');

        if(onlyMissing && (data[i].y == null)){
            shefMessage = '.AR ' + nwsLid.toUpperCase() +' '+date+' Z DH'+time+'/DC'+dc+'/'+pedts+' -9999\n';
        }
        else if(!onlyMissing){
            shefMessage = '.AR ' + nwsLid.toUpperCase() +' '+date+' Z DH'+time+'/DC'+dc+'/'+pedts+' '+data[i].y.toFixed(2)+'\n';
        }
        shefData = shefData + shefMessage;
    }
    return shefData;
}


///////////////////////////////////
//  Linear Interpolation
///////////////////////////////////

function lineInterpolate( point1, point2,XorY,value){
  var result = new Object();
  if(XorY == 'x'){
  result.y = value;
  ratio = (value-point1.y)/(point2.y-point1.y);
  result.x = Math.round(point1.x+ratio*(point2.x-point1.x));
  }
  if(XorY == 'y'){
  result.x = value;
  ratio = (value-point1.x)/(point2.x-point1.x);
  result.y = Math.round(point1.y+ratio*(point2.y-point1.y));
  }
  return result;
}

///////////////////////////////////
//  Calculate area under the curve
///////////////////////////////////

function volumeUnderCurve(flowData,xMin=0,xMax=0){
    console.log(flowData);
    if((xMin==0)&&(xMax==0)){
        xMin = flowData.xData[0];
        xMax = flowData.xData[flowData.xData.length-1];
    }
    console.log(xMin);
    console.log(xMax);
    if(xMin>xMax){
        var temp = xMin;
        xMin = xMax;
        xMax = temp;
    }
    var volume = 0;
    var volArray = [];
    for(i=0;i<flowData.data.length-1;i++){
        if(typeof flowData.data[i] == 'undefined') continue;
        if((flowData.data[i].x <= xMin) && (flowData.data[i+1].x > xMin)){
            point = lineInterpolate(flowData.data[i],flowData.data[i+1],'y',xMin);
            volArray.push(point);
        }
        if((flowData.data[i].x > xMin) && (flowData.data[i].x < xMax)){
            volArray.push(flowData.data[i]);
        }
        if((flowData.data[i].x <= xMax) && (flowData.data[i+1].x > xMax)){
            point = lineInterpolate(flowData.data[i],flowData.data[i+1],'y',xMax);
            volArray.push(point);
        }
    }
    for(i=0;i<volArray.length-1;i++){
        volume += ((volArray[i].y+volArray[i+1].y)/2)*((volArray[i+1].x-volArray[i].x)/1000);
        }
    acreFeet = volume/43560;
    return acreFeet;
}

///////////////////////////////////
//  Add straight line base flow to graph
///////////////////////////////////

function addBaseFlowSeries(chart,flowData,xMin,xMax){
    var volArray = [];
    var pt1;
    var pt2;

    for(var i=0;i<flowData.data.length-1;i++){
        if(typeof flowData.data[i] == 'undefined') continue;
        if((flowData.data[i].x <= xMin) && (flowData.data[i+1].x > xMin)){
           pt1   = lineInterpolate(flowData.data[i],flowData.data[i+1],'y',xMin);
        }
        if((flowData.data[i].x <= xMax) && (flowData.data[i+1].x > xMax)){
           pt2 = lineInterpolate(flowData.data[i],flowData.data[i+1],'y',xMax);
        }
    }

    for(var z=0;z<=9;z++){
        var newX = xMin+(((xMax-xMin)/9)*z);
        var newY = pt1.y+(((pt2.y-pt1.y)/9)*z);
        var tempPt;
        for(var i=0;i<flowData.data.length-1;i++){
            if(typeof flowData.data[i] == 'undefined') continue;

            if((flowData.data[i].x <= newX) && (flowData.data[i+1].x > newX)){
                var tempPt = lineInterpolate(flowData.data[i],flowData.data[i+1],'y',newX);
                if(tempPt.y<newY){
                    volArray.push(tempPt);
                }else{
                    volArray.push([newX,newY]);
                }
            }
        }
    }
    console.log(volArray);
    newSeries ={
        type: "area",
        data: volArray,
        name:'Base Flow',
        color: 'grey',
        id: 'baseFlow',
        dataGrouping: {
             	enabled: false
        }
    };
    chart.addSeries(newSeries);
    return;
}


function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
}


function addAnnualData(chartDiv,dv_iv,year = 'all'){
    var chartAdd = $('#'+chartDiv).highcharts();

    var usgsID = chartAdd.options.usgsID;
    var cD = '00060';
    var start = '1900-01-01';
    var end = '2020-01-01';
    if(year != 'all'){
        start = year+'-01-01';
        end = year+'-12-31';
    }

    var usgsUrl = "http://nwis.waterservices.usgs.gov/nwis/iv/?format=json&sites="+usgsID+"&parameterCd="+cD+"&startDT="+start+"&endDT="+end;
    var durLabel = 'Instantaneous';
    var lineColor = 'royalblue';
    var lineIndex = 2;
    if(dv_iv == 'dv'){
        durLabel = 'Daily';
        lineColor = 'darkgreen';
        seriesId = 'USGSdv';
        lineIndex = 3;
        usgsUrl = "http://waterservices.usgs.gov/nwis/dv/?format=json&sites="+usgsID+"&parameterCd="+cD+"&startDT="+start+"&endDT="+end;
    };

    $.ajax({
        url: usgsUrl,
        dataType: 'json',
        //async: false,
        timeout: 20000, // sets timeout to 3 seconds
        success: function(json){
            if(json.value.timeSeries.length>0){
                var allData = USGStoHC(json,"00060");
                var workingYear = moment(allData[0][0]).format("YYYY");
                var yearData = [];
                var olddate = 0;
                for(var i=0;i<allData.length;i++){
                    var years = 2016 - workingYear;
                    var date = moment(allData[i][0]).add(years, 'years');
                    if(date.valueOf() > olddate){
                        yearData.push([date.valueOf(),allData[i][1]]);
                        olddate = date.valueOf();
                    }

                }

                newSeries ={
                    data: yearData,
                    name:workingYear+'-'+dv_iv,
                    param: 'stage',
                    source: 'USGS',
                    timeShift: true,
                    calcVol: true,
                    USGSid:usgsID,
                    dateShift:0,
                    tooltip: {
                        headerFormat:'<b>{point.x:%Y-%m-%d}</b><br>',
                        pointFormatter: function (){
                            if(this.series.options.dateShift == 0){
                                return '<b>'+numberWithCommas(this.y) + ' cfs</b>';
                            }else{
                                return '<b>'+numberWithCommas(this.y) + ' cfs</b><br>(Orig. Date: '+moment(this.series.options.dateShift+this.x).format("YYYY-MM-DD H:mm")+')' ;
                            }
                        },
                    },

                };
                chartAdd.addSeries(newSeries);
                }
            }

    })

}


function addUSGS(chartDiv,type = 'discharge',dv_iv,USGSsiteID = null){
    var chartAdd = $('#'+chartDiv).highcharts();
    var style = 'dashed';
    var siteLabel = USGSsiteID;

    if(USGSsiteID == null){
        USGSsiteID = chartAdd.options.usgsID;
        style = 'solid';
        siteLabel = '';
    }

    var extX = chartAdd.xAxis[0].getExtremes();
    var cD = '00060';
    var unit = 'cfs';
    var seriesId = 'USGSiv';
    if(type == 'stage') {
        cD = '00065';
        unit = 'ft';
    }
    var newSeries;
    var start = Highcharts.dateFormat('%Y-%m-%d',extX.min-3600*1000*24);
    var end = Highcharts.dateFormat('%Y-%m-%d',extX.max);

    usgsUrl = "http://nwis.waterservices.usgs.gov/nwis/iv/?format=json&sites="+USGSsiteID+"&parameterCd="+cD+"&startDT="+start+"&endDT="+end;
    var durLabel = 'Instantaneous';
    var lineColor = 'royalblue';
    var lineIndex = 2;
    if(dv_iv == 'dv'){
        durLabel = 'Daily';
        lineColor = 'darkgreen';
        seriesId = 'USGSdv';
        lineIndex = 3;
        usgsUrl = "http://waterservices.usgs.gov/nwis/dv/?format=json&sites="+USGSsiteID+"&parameterCd="+cD+"&startDT="+start+"&endDT="+end;
    }
    if(style == 'dashed')lineColor = '';
    $.ajax({
        url: usgsUrl,
        dataType: 'json',
        //async: false,
        timeout: 20000, // sets timeout to 3 seconds
        success: function(json){
            if(json.value.timeSeries.length>0){
                newSeries ={
                    data: USGStoHC(json,"00060"),
                    name:'USGS '+durLabel+' '+siteLabel,
                    zIndex:lineIndex,
                    color: lineColor,
                    dashStyle:style,
                    qual: 'Observed',
                    id: seriesId,
                    param: 'stage',
                    source: 'USGS',
                    calcVol: true,
                    USGSid:USGSsiteID,

                };
                chartAdd.addSeries(newSeries);
            }
        },
    })

}


function getAhps(site,AHPS){
    var data;
    var result;
    if (typeof AHPS[site] === 'undefined') {
        $.ajax({
            url: "get_ahps_data.php?format=json&site="+nwsLid,
            dataType: 'json',
            data: data,
            async: false,
            success: function(data){
                AHPS[site] = data.site;
                result = true;
                },
            error: function(){
                    result = false;
                }
        })
    }else{
        //console.log('AHPS already loaded');
        result = true;
    }
    return result;
}


function addAHPS(chartDiv,type = 'discharge'){
    var chartAdd = $('#'+chartDiv).highcharts();
    nwsLid = chartAdd.options.nwsLid;
    var issued= '';
    var newSeries=[];

    var tzoffset = -1000*(new Date().getTimezoneOffset());

    //Load AHPS data if it is not already loaded
    if(getAhps(nwsLid,AHPSjson) == true){
        issued =  Highcharts.dateFormat('%l %P %b %e',(new Date(AHPSjson[nwsLid].forecast._issued).getTime())+tzoffset);
     }
     else{
        issued = 'No forecast';
     }


    //chartAdd.setTitle({ text: AHPSjson[nwsLid]._name});

    var stageArray = [];
    var dischargeArray = [];
    try{
        if(typeof AHPSjson[nwsLid].forecast.datum != 'undefined'){
            $.each(AHPSjson[nwsLid].forecast.datum, function(){
                var mult = 1;
                var d = new Date(this.valid.value).getTime();
                stageArray.push([parseInt(d),parseFloat(this.primary.value)]);
                if(this.secondary._units == 'kcfs') mult = 1000;
                dischargeArray.push([parseInt(d),parseFloat(this.secondary.value)*mult]);
            });

            newSeries.push({
                data : stageArray,
                name : 'NWS Forecast ( Issued: '+issued+' )',
                color: 'purple',
                qual: 'Forecast',
                param: 'stage',
                pedts: AHPSjson[nwsLid].forecast.datum[0].pedts,
                source: 'NWS',
                draggableY: true,
                id:'nwsStageForecast',
                NWSid: nwsLid,
                zIndex:3,
            });

            if(dischargeArray.length>0){
                newSeries.push({
                    data : dischargeArray,
                    name : 'NWS Forecast( Issued: '+issued+' )',
                    color: 'purple',
                    qual: 'Forecast',
                    param: 'discharge',
                    id:'nwsDischargeForecast',
                    calcVol: true,
                    draggableY: true,
                    source: 'NWS',
                    NWSid: nwsLid,
                    zIndex:3,
                });
            }
        }
    }
    catch(e){}


    var stageArray = [];
    var dischargeArray = [];
    try{
        if(typeof AHPSjson[nwsLid].observed.datum != 'undefined'){
            $.each(AHPSjson[nwsLid].observed.datum, function(){
                var mult = 1;
                var d = new Date(this.valid.value).getTime();
                stageArray.push([parseInt(d),parseFloat(this.primary.value)]);
                if(typeof this.secondary != 'undefined'){
                    if(this.secondary._units == 'kcfs') mult = 1000;
                    dischargeArray.push([parseInt(d),parseFloat(this.secondary.value)*mult]);
                }

            });

            newSeries.push({
                data : stageArray.sort(),
                name : 'NWS Observed',
                color: 'green',
                qual: 'Observed',
                param: 'stage',
                pedts: AHPSjson[nwsLid].observed.datum[0].pedts,
                draggableY: true,
                dateShift:0,
                source: 'NWS',
                NWSid: nwsLid,
                id: 'nwsStageObserved',
                zIndex:3,
            });

            if(dischargeArray.length>0){
                newSeries.push({
                    data : dischargeArray.sort(),
                    name : 'NWS Observed',
                    color: 'green',
                    qual: 'Observed',
                    param: 'discharge',
                    dateShift: 0,
                    calcVol: true,
                    id: 'nwsDischargeObserved',
                    source: 'NWS',
                    NWSid: nwsLid,
                    zIndex:3,
                });
            }
        }
    }
    catch(e){
        console.log('No observed AHPS data: '+e);
    }

    $.each(newSeries, function(){
        if(this.param == type){
            chartAdd.addSeries(this);
        }
    });


}

function addMeasureQ_Rating(chartDiv,usgsID,type){
    var chart = $('#'+chartDiv).highcharts();
    if(usgsID == null){
        usgsID = chart.options.usgsID;
    }

    $.ajax({
        url: "rdbajax.php?site="+usgsID+"&type=qmeas",
        dataType: 'json',
        data: '',
        success: function(json){

            var newSeries = qMeasJSON2HC_Rating(json,type);
            for(j = 0;j < newSeries.length;j++){
                if(json.error_info.error == 0){
                    chart.addSeries(newSeries[j]);
                }
            }
        }
    });
}

function addPeakFlow(chartDiv,year='2016'){
    if(year == '2016'){
        halign = 'left';
        style = 'solid';
    }
    else{
        halign = 'right';
        style = 'longdashdot';
    }
    var chart = $('#'+chartDiv).highcharts();
    usgsID = chart.options.usgsID;
    $.ajax({
        url: "Flood_Stats.json",
        dataType: 'json',
        data: '',
        success: function(json){
            if(typeof json[usgsID] != 'undefined'){
                //console.log(json[usgsID]);
                if(typeof json[usgsID][year] != undefined){
                    var source = 'wtd';
                    if(json[usgsID][year]['2yr'][source] == "") source = 'sta';

                    chart.yAxis[0].addPlotLine({
                        value: json[usgsID][year]['2yr'][source],
                        color: 'yellow',
                        width:2,
                        id: 'ffline'+year,
                        dashStyle: style,
                        label:{
                            align: halign,
                            text: '2 Year '+source+' ('+year+')'
                        }
                    });
                    chart.yAxis[0].addPlotLine({
                        value: json[usgsID][year]['10yr'][source],
                        color: 'orange',
                        width:2,
                        id: 'ffline'+year,
                        dashStyle: style,
                        label:{
                            align: halign,
                            text: '10 Year '+source+' ('+year+')'
                        }
                    });
                    chart.yAxis[0].addPlotLine({
                        value: json[usgsID][year]['25yr'][source],
                        color: 'red',
                        width:2,
                        id: 'ffline'+year,
                        dashStyle: style,
                        label:{
                            align: halign,
                            text: '25 Year '+source+' ('+year+')'
                        }
                    });
                    chart.yAxis[0].addPlotLine({
                        value: json[usgsID][year]['100yr'][source],
                        color: 'blue',
                        width:2,
                        id: 'ffline'+year,
                        dashStyle: style,
                        label:{
                            align: halign,
                            text: '100 Year '+source+' ('+year+')'
                        }
                    });
                }
            }
        }
    });

}



function addAnnualPeaks(chartDiv,state='ak'){
    var chart = $('#'+chartDiv).highcharts();
    var usgsID = chart.options.usgsID;
    $.get("rdbajax.php?site="+usgsID+"&type=annualPeaks&state="+state, function( data ) {
        var chart = $('#'+chartDiv).highcharts();
        var year = new Date().getFullYear();
        var peakSeries = [
            {
                name: 'Annual Peaks',
                tooltip: {
                    headerFormat:'<b>Peak Annual Flow<br>{point.x:%b %e %Y}</b><br>',
                    pointFormatter: function (){
                        return '<b>' +numberWithCommas(this.y) + ' cfs</b>';
                    },
                },
                states: {
                    hover: {
                        enabled: false
                    }
                },
                data:[],
                visible: true,
                lineWidth: 0,
                type: 'scatter',
                zIndex:15,
                calcVol: false,
                id:'annualPeaks',
                color: 'orange',
                dataLabels: {
                    enabled: true,
                    format: '{point.x:%Y-%m-%d}<br>{point.y} cfs',
                    y: -3,
                    style:{
                         "fontSize": "9px",
                    },
                },
                marker : {
                    enabled : true,
                    radius : 4
                },
                showInLegend:true
            },
            {
                name: 'Annual Peaks (2016)',
                tooltip: {
                    headerFormat: 'Peak Annual Flow<br>',
                    pointFormatter: function (){
                        return '<b>' +this.peakDate+': '+numberWithCommas(this.y) + ' cfs</b>';
                    },
                },
                states: {
                    hover: {
                        enabled: false
                    }
                },
                data:[],
                type: 'scatter',
                visible: true,
                id:'annualPeakYear',
                calcVol: false,
                lineWidth: 0,
                padding:0,
                dataLabels: {
                    enabled: true,
                    format: '{point.year}',
                    y: -3,
                    style:{
                         "fontSize": "9px",
                    },
                },
                zIndex:15,
                color: 'black',
                marker : {
                    enabled : true,
                    radius : 4
                },
                showInLegend:true
            }];
         $.each(data.records,function(){
            var newD = this[2].split('-');
            var d= Date.UTC(newD[0],newD[1]-1,newD[2],20);

            var point = [d,this[4]];
            peakSeries[0].data.push([d,this[4]]);
            d= Date.UTC(year,newD[1]-1,newD[2],20);
            point = {x:d,
                     y:this[4],
                     peakDate:this[2],
                     year:newD[0]
                     }
            peakSeries[1].data.push(point);

          });

        chart.addSeries(peakSeries[0]);
        //peakSeries[1].data.sort(sortDate);
        chart.addSeries(peakSeries[1]);

    })
}






function addStats(chartDiv){
    var chartAdd = $('#'+chartDiv).highcharts();
    var usgsID = chartAdd.options.usgsID;
    $.get('http://waterservices.usgs.gov/nwis/stat/?format=rdb,1.0&indent=on&sites='+usgsID+'&statReportType=daily&statTypeCd=min,max,median,p05,p25,p75,p95&parameterCd=00060', function( data ) {


        var lines = data.split('\n');
        var statsSeries = [
            {
                name: 'Daily Statistics',
                data: [],
                //visible : true,
                type: 'scatter',
                lineWidth: 1,
                color: '#ECC5C0',
                calcVol: false,
                zIndex: 0,
                showInLegend:true,
                tooltip:{
                    headerFormat:'<b>{point.x:%b %e}</b><br>',
                    pointFormatter: function (){
                        return '<b>'+numberWithCommas(this.y) + ' cfs (year: '+this.year+')</b>';
                    },
                }
            },
            {
                name: 'Max Flows',
                data: [],
                //visible : true,
                type: 'arearange',
                calcVol: false,
                lineWidth: 1,
                color: '#ECC5C0',
                fillOpacity: 0.1,
                zIndex: 0,
                showInLegend:false,
                linkedTo: ':previous',
                tooltip:{
                     headerFormat:'<b>{point.x:%b %e}</b><br>',
               }
            },
            {
                name: 'P 5% -  95%',
                data: [],
                //visible : true,
                trackByArea: true,
                type: 'arearange',
                calcVol: false,
                lineWidth: 0,
                linkedTo: ':previous',
                color: '#00bfff',
                fillOpacity: 0.2,
                zIndex: 1,
                tooltip:{
                    headerFormat:'<b>{point.x:%b %e}</b><br>',
                }
           },
            {
                name: 'P 25% - 75%',
                data: [],
                //visible : true,
                trackByArea: true,
                type: 'arearange',
                calcVol: false,
                lineWidth: 0,
                linkedTo: ':previous',
                color: '#0040ff',
                fillOpacity: 0.3,
                zIndex: 2,
                tooltip:{
                    headerFormat:'<b>{point.x:%b %e}</b><br>',
                }
            },
            {
                name: 'P 50% (median)',
                linkedTo: ':previous',
                color: '#D1D0CE',
                data: [],
                zIndex: 3,
                tooltip:{
                    headerFormat:'<b>{point.x:%b %e}</b><br>',
                }
            },
            {
                name: 'Count',
                data: [],
                showInLegend:false,
                visible : false
            },
            {
                name: 'Min Year',
                data: [],
                showInLegend:false,
                visible : false
            },
            {
                name: 'Max year',
                data: [],
                showInLegend:false,
                visible : false
            }
        ];
        var annualSeries =[
            {
                data:[]
             },
            {
                data:[]
             },
            {
                data:[]
             },
            {
                data:[]
             },
            {
                data:[]
             },
            {
                data:[]
             },
            {
                data:[]
             },{
                data:[]
             }];

        $.each(lines, function(){
        if (this.substring(0, 4) == "USGS") {
            var tdata = this.split('\t');

            for(i=0;i<tdata.length;i++){
                if(parseInt(tdata[i]) == 0 ) tdata[i]= 1;
                if(parseInt(tdata[i]) > 0 ) tdata[i]= parseInt(tdata[i]);
                if(tdata[i].length == 0) tdata[i] = null;
            }

            var month = tdata[5]-1;
            var day = tdata[6];
            var year = '2016';
            var vdate = Date.UTC(year,month,day,20);    //Noon ak standard time
            if(month > 8) tdata[10] = tdata[10]-1;
            //console.log(year+'-'+month+'-'+day);
            var minData = {x:vdate,y:tdata[13],year:tdata[12]};
            var maxData = {x:vdate,y:tdata[11],year:tdata[10]};
            annualSeries[0].data[vdate] = maxData;
            annualSeries[1].data[vdate] = [vdate,tdata[13],tdata[11]];
            annualSeries[2].data[vdate] = [vdate,tdata[14],tdata[18]];
            annualSeries[3].data[vdate] = [vdate,tdata[15],tdata[17]];
            annualSeries[4].data[vdate] = [vdate,tdata[16]];
            annualSeries[5].data[vdate] = [vdate,tdata[9]];
            annualSeries[6].data[vdate] = [vdate,tdata[12]];
            annualSeries[7].data[vdate] = [vdate,tdata[10]];
        }

        });

        var extX = chartAdd.xAxis[0].getExtremes();

        var days= 1;
        var sdate= new Date(extX.min);
        var edate = new Date(extX.max);

        while (sdate < edate){

            month = sdate.getMonth();
            day = sdate.getDate();
            year= sdate.getFullYear();
            var plotDate = sdate;
            plotDate.setHours(12);
            datetime = plotDate.getTime();
            var annualdate =Date.UTC('2016',month,day,20);

            var newDate = sdate.setDate(sdate.getDate() + 1);
            sdate = new Date(newDate);
            days++;

            //Skip Feb 29th - it tends to through off the plot
            if(month ==1 && day == 29) continue;

            //Push max and min data into series
            var dat = annualSeries[0].data[annualdate];
            if(typeof dat !== 'undefined'){
                dat.x = datetime;
                statsSeries[0].data.push(dat);
            }
            for(var j=1;j<=7;j++){
                dat = annualSeries[j].data[annualdate];
                if(typeof dat !== 'undefined'){

                    if(dat.length ==3){
                        statsSeries[j].data.push([datetime,dat[1],dat[2]]);
                     }else{
                        statsSeries[j].data.push([datetime,dat[1],dat[2]]);
                     }
                }
            }

        }


        $.each(statsSeries,function(){
            this.marker = { enabled:false};
            if(1){
                chartAdd.addSeries(this);
            }
        });
      });
}


function initializeNWS() {
  NWS = {
            stage :{
              low : {
                text: 'Low Flow Stage',
                   value: 9999,
                   def:''
                 },
            bankfull : {
                text: 'Bankfull Stage',
                   value: 9999
                },
            action : {
                text: 'Action Stage',
                   value: 9999,
                   def:'A stream, lake or reservoir has rised to a level where you should prepare for possible significant flooding'
                },
            flood : {
                text: 'Flood Stage',
                   value: 9999,
                   def:'Minimal or no property damage, but possibly some public threat'
                },
            moderate : {
                text: 'Moderate Flood Stage',
                   value: 9999,
                   def: 'Some inundation of structures and roads near streams. Some evacuations of people and/or transfer of property to higher elevations are necessary'
                 },
            major : {
                text: 'Major Flood Stage',
                   value: 9999,
                   def:'Extensive inundation of structures and roads. Significant evacuations of people and/or transfer of property to higher elevations'
                 },
            record: {
                text: 'Record Stage',
                   value: 9999,
                   def:'Highest stage at a given site during the period of record'
                 }
            },
            maxY : -9999,
            nwsTitle: '',
            usgsTitle:'',
            forecastStage: [],
            observedStage: [],
            forecastDischarge: [],
            observedDischarge: [],
            sources:[],
            stageSeries: [],
            dailyUSGS: [],
            ratingsSeries:[],
            dischargeSeries: [],
            forecastIssued : ''
  }

}






function getRDBSiteInfo(RDB,values){
    var data = { }

    var extractVals = new Array();
    var keys = [];
    var values = [];
    var lines = RDB.split('\n');

    //Iterate through the comment lines of the RDB file
    var j = 0
    for(j = 0;j < lines.length;j++){
      if(lines[j].charAt(0) != '#') break
    }
    var keys = lines[j].split('\t')
    j = j+2

    var values = lines[j].split('\t');

    for (i = 0; i < keys.length; i++) {
       data[keys[i]] = values[i];
    }

    return data
  }


function GetObjectKeyIndex(obj, keyToFind) {
    var i = 0, key;
    for (key in obj) {
        if (key == keyToFind) {
            return i;
        }
        i++;
    }
    return null;
}


function ratingLookup(rating,value,type = 'discharge'){
    //Assumes rating is [discharge,stage]
    var lowx;
    var highx;
    var lowy;
    var highy;
    var lookupValue;

    if(type == 'discharge'){
        $.each(rating,function(key,val){
           if(value == val.x){
                lookValue = val.y;
                return false;
           }
           if(value < val.x) {
                highx = val.x;
                highy = val.y;
                lowx = rating[key-1].x;
                lowy =  rating[key-1].y;
                lookValue = ((highx-value)/(value-lowx))*(highy-lowy)+lowy
                return false;
            }
        });
    }
    if(type == 'stage'){
        $.each(rating,function(key,val){
           if(value == val.y){
                lookValue = val.x;
                return false;
           }
           if(value < val.y) {
                highx = val.x;
                highy = val.y;
                lowx = rating[key-1].x;
                lowy =  rating[key-1].y;
                lookValue = ((highy-value)/(value-lowy))*(highx-lowx)+lowx
                return false;
            }
        });
    }
    return lookValue;
}

function ratingJSON2HC(json){
    var indepIndex = GetObjectKeyIndex(json.columns,"INDEP");
    var depIndex = GetObjectKeyIndex(json.columns,"DEP");
    var series = {};

    len = json.records.length;

    if(len == 0) return data = null;

    var data = new Array();
    for (var i = 0; i < len; i++) {
        if(json.records[i][indepIndex] > 0) data.push([json.records[i][depIndex],json.records[i][indepIndex]]);
    }
    series['data'] = data;

    series['name'] = 'USGS Rating Curve';
    series['zIndex'] = 9;
    series['id'] = 'curve',
    series['tooltip']= {
                headerFormat: 'USGS Rating Curve<br>',
                pointFormat: 'Gage Height: {point.y} ft Discharge: {point.x} cfs  </b>'
    };
    return series;
}

function sortFunction(a, b) {
    if (a.x === b.x ){
        return 0;
    }
    else {
        return (a.x < b.x) ? -1 : 1;
    }
}

function sortNinthCol(a, b) {
    if (a[9] === b[9] ){
        return 0;
    }
    else {
        return (a[9] < b[9]) ? -1 : 1;
    }
}

function sortFirstCol(a, b) {
    if (a[0] === b[0] ){
        return 0;
    }
    else {
        return (a[0] < b[0]) ? -1 : 1;
    }
}

function sortDate(a,b) {
  if (a.x < b.x)
    return -1;
  else if (a.x > b.x)
    return 1;
  else
    return 0;
}

function numberWithCommas(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

function dateFromDay(year, day){
  var date = new Date(year, 0); // initialize a date in `year-01-01`
  return new Date(date.setDate(day)); // add the number of days
}



function qMeasJSON2HC_Rating(json,type = 'curve'){
    var indepIndex = GetObjectKeyIndex(json.columns,"discharge_va");
    var depIndex = GetObjectKeyIndex(json.columns,"gage_height_va");
    var dtIndex = GetObjectKeyIndex(json.columns,"measurement_dt");
    var tzIndex = GetObjectKeyIndex(json.columns,"tz_cd");
    var xVal,yVal;
    var base = {
           data: [],
           tooltip: {
                headerFormat: 'USGS Measured Discharge<br>',
                pointFormat: '{point.name} <br>Gage Height:{point.gage_height_va} ft<br>Discharge:{point.discharge_va} cfs<br>Quality:{point.measured_rating_diff}<br>Control: {point.control_type_cd}'
            },
            name: 'USGS Measured',
            type: 'scatter',
            zIndex : 1,
            marker : {
                enabled : true,
                fillColor:'red',
                symbol: 'diamond'
            },
            lineWidth : 0,
            states:{
                hover:{
                    enabled : true,
                    lineWidth:0,
                    lineWidthPlus:0
                }
             }
        }
    var allSeries = [base];
    allSeries.push(jQuery.extend(true, {}, base));
    allSeries.push(jQuery.extend(true, {}, base));
    allSeries.push(jQuery.extend(true, {}, base));
    allSeries.push(jQuery.extend(true, {}, base));
    allSeries[0].zIndex = 6;
    allSeries[1].zIndex = 5;
    allSeries[2].zIndex = 4;
    allSeries[3].zIndex = 3;
    allSeries[4].zIndex = 2;
    allSeries[1].linkedTo = ':previous';
    allSeries[2].linkedTo = ':previous';
    allSeries[3].linkedTo = ':previous';
    allSeries[4].linkedTo = ':previous';
    allSeries[0].marker.fillColor = 'red';
    allSeries[1].marker.fillColor = 'orange';
    allSeries[2].marker.fillColor = 'rgba(0,0,205,0.5)';
    allSeries[3].marker.fillColor = 'rgba(0,0,205,0.3)';
    allSeries[4].marker.fillColor = 'rgba(0,0,205,0.1)';

    json.records = json.records.sort(sortNinthCol);
    len = json.records.length;

    if(len == 0) return data = null;


    var mostRecentDate = 0;
    for (var i = 0; i < len; i++) {
        var ratingInfo = {}
        var j = 0;
        $.each(json.columns,function(key,value){
            ratingInfo[key] = json.records[i][j];
            j++;
        });

        //Check if stage is included and if discharge is not zero
        if((json.records[i][depIndex]=== null) || (Math.abs(json.records[i][indepIndex])=== 0)) continue;

        date = new Date(json.records[i][dtIndex]);
        date = moment(json.records[i][dtIndex]);


        if(type == 'curve'){
            xVal = json.records[i][indepIndex];
            yVal = json.records[i][depIndex];
         }else{
            xVal = date;
            yVal = json.records[i][indepIndex];

         }

        ratingInfo = $.extend({
            'x' : xVal,
            'y': yVal,
            //'name': date.toDateString()
            'name': date.format('MMMM Do YYYY, h:mm:ss a')
            },
            ratingInfo);


        if(date > mostRecentDate) {
            allSeries[0].data[0] = ratingInfo;
            mostRecentDate = date;
        }
        age = moment().diff(date,'years',true);
        var index = 4;
        if(age < 10) index =3 ;
        if(age < 5) index = 2;
        if(age < 1 ) index = 1;

        if(type != 'curve') index = 0;
        allSeries[index].data.push(ratingInfo);

    }
    return allSeries;
}


function USGStoHC(usgsObj,TSvalue){
    var len = usgsObj.value.timeSeries.length;
    if(len == 0) return data = null;
    var urlSource = usgsObj.value.queryInfo.queryURL;
    var isDaily= urlSource.match(/dv/);
    var tzoffset = '';
    if(isDaily){
        var tzoffset = usgsObj.value.timeSeries[0].sourceInfo.timeZoneInfo.defaultTimeZone.zoneOffset;
    }
    var data = new Array();
    var QRarr = 0;
    for (var i = 0; i < len; i++) {
        if (usgsObj.value.timeSeries[i].variable.variableCode[0].value == TSvalue){
            QRarr = i;
            break;
        }
    }

    var numQ = usgsObj.value.timeSeries[QRarr].values[0].value.length;
    var olddate = moment("1900-01-01");

   // console.log(olddate);
    for (var i = 0; i < numQ; i++) {
        d = moment(usgsObj.value.timeSeries[QRarr].values[0].value[i].dateTime+tzoffset);
        if(isDaily) d.hour(12);
        val = usgsObj.value.timeSeries[QRarr].values[0].value[i].value;
        val = parseFloat(val);

        if(val < -999) val  = null;
        if(val != null){
            if(val <= 0) val = null;
        }

        if(d > olddate){
            data.push([parseInt(d.format("x")),val]);
            olddate = d;
        }else{
            console.log('backwards'+d.format());

        }

    }

    return data;
}

function USGSDailytoHCHeat(usgsObj,TSvalue){
    len = usgsObj.value.timeSeries.length;
    if(len == 0) return data = null;
    data = new Array()
    QRarr = 0;
    for (var i = 0; i < len; i++) {
      if (usgsObj.value.timeSeries[i].variable.variableCode[0].value == TSvalue){
        QRarr = i;
        break;
      }
    }
    numQ = usgsObj.value.timeSeries[QRarr].values[0].value.length;
    for (var i = 0; i < numQ; i++) {
      var d = new Date(usgsObj.value.timeSeries[QRarr].values[0].value[i].dateTime);

      var year = d.getFullYear();
      var start = new Date(year,0,0);
      var diff = d - start;
      var oneDay = 1000 * 60 * 60 * 24;
      var day = Math.floor(diff / oneDay);
      val = usgsObj.value.timeSeries[QRarr].values[0].value[i].value
      //val = Math.log(parseFloat(val));
      val = parseFloat(val);
      if(val < 1) val  = 1;
      data.push([parseInt(day),parseInt(year),val])
    }
    return data
}


/**
 * Add the NWS flood level bands to the chart
 *
 */
function addNWSBands(graphId,AHPSjson,addTable = true,type = 'band',setTicks = true){
    var chart = $('#'+graphId).highcharts();

    var nwsLid = chart.options.nwsLid;
    var extremes = chart.yAxis[0].getExtremes();
    if(getAhps(nwsLid,AHPSjson) == false) return;

    var legW = 550;
    var col1Width = 170;
    var legendy = chart.chartHeight-chart.margin[2]+70;
    var legTextHeight = 10;
    var cellPadding = 1;
    var legendx = 110;
    var upperEnd = 9999;
    var maxY = extremes.dataMax;
    var colors = {
        major : 'rgba(204,51,255,0.7)',
        moderate : 'rgba(255,0,0,0.7)',
        flood : 'rgba(255,153,0,0.7)',
        action : 'rgba(255,255,0,0.7)',
    };
    stage ={
        low : {
            text: 'Low Flow Stage',
            value: extremes.max,
            def:''
        },
        bankfull : {
            text: 'Bankfull Stage',
            value: extremes.max
        },
        action : {
            text: 'Action Stage',
            value: extremes.max,
            def:'A stream, lake or reservoir has rised to a level where you should prepare for possible significant flooding'
        },
        flood : {
            text: 'Flood Stage',
            value: extremes.max,
            def:'Minimal or no property damage, but possible some public threat'
        },
        moderate : {
            text: 'Moderate Flood Stage',
            value: extremes.max,
            def: 'Some inundation of structures and roads near streams. Some evacuations of people and/or transfer of property to higher elevations are necessary'
        },
        major : {
            text: 'Major Flood Stage',
            value: extremes.max+10,
            def:'Extensive inundation of structures and roads. Significant evacuations of people and/or transfer of property to higher elevations'
        },
        record: {
            text: 'Record Stage',
            value: extremes.max,
            def:'Highest stage at a given site during the period of record'
        }
    };


    $.each( colors, function( key, value ){
        if(typeof AHPSjson[nwsLid].sigstages[key].value != 'undefined'){
            if(AHPSjson[nwsLid].sigstages[key].value > maxY){
                maxY = parseInt(AHPSjson[nwsLid].sigstages[key].value);
            }
            if(type == 'band'){
                chart.yAxis[0].addPlotBand({
                    from: AHPSjson[nwsLid].sigstages[key].value,
                    to: upperEnd,
                    color: value,
                    id : 'plotBand',
                    zIndex:0
                })
            }
            else{
                chart.yAxis[0].addPlotLine({
                    value: AHPSjson[nwsLid].sigstages[key].value,
                    color: value,
                    id : 'plotLine',
                    zIndex:1,
                    width:2,

                })
            }

            chart.yAxis[0].addPlotLine({
                color: 'black',
                width: 1,
                zIndex:6,
                id: 'plotLine',
                value: AHPSjson[nwsLid].sigstages[key].value,
                label: {
                    text: key.capitalize()+': '+AHPSjson[nwsLid].sigstages[key].value+' '+AHPSjson[nwsLid].sigstages[key]._units,
                    textAlign: 'left',
                    fontWeight: 'bold',
                    y:-2
                }
            })

            upperEnd = AHPSjson[nwsLid].sigstages[key].value

            if(addTable == false) return;
            text = chart.renderer.text(stage[key].text,legendx,legendy)
                .attr({
                    zIndex:6,
                class:'nwsLegend'})
                .css({
                    color: 'black',
                        'text-align': 'center',
                        'font-weight': 'bold',
                        width:  col1Width,
                        fontSize: legTextHeight+'px'
                }).add();
            text = chart.renderer.text(AHPSjson[nwsLid].sigstages[key].value+' '+AHPSjson[nwsLid].sigstages[key]._units,legendx+col1Width-40,legendy)
                .attr({
                    zIndex:6,
                class:'nwsLegend'})
                .css({
                    color: 'black',
                        'text-align': 'center',
                        'font-weight': 'bold',
                        width:  col1Width,
                        fontSize: legTextHeight+'px'
                }).add();
            text = chart.renderer.text(stage[key].def,legendx+col1Width,legendy)
                .attr({
                    zIndex:6,
                    class:'nwsLegend'})
                .css({
                    color: 'black',
                    'text-align': 'center',
                    width:  legW-col1Width,
                    fontSize: legTextHeight+'px'
                }).add();
            chart.renderer.rect(legendx - 5,legendy-legTextHeight-cellPadding, legW+5, 2*legTextHeight+5*cellPadding, 0)
                .attr({
                    fill: value,
                    stroke: value,
                    class: 'nwsLegend',
                    zIndex: 4
                }).add();
            legendy = legendy+2*legTextHeight+5*cellPadding
        }
    });
    if(typeof AHPSjson[nwsLid].sigstages.record === 'object'){
        if(AHPSjson[nwsLid].sigstages.record.value > maxY){
            maxY = parseInt(AHPSjson[nwsLid].sigstages.record.value);
        }
        chart.yAxis[0].addPlotLine({
            color: '#99FFFF',
            width: 2,
            zIndex:6,
            value: AHPSjson[nwsLid].sigstages.record.value,
            dashStyle: 'longDash',
            id : 'plotLine',
            label: {
                text: 'NWS Record Stage: '+AHPSjson[nwsLid].sigstages.record.value+' '+AHPSjson[nwsLid].sigstages.record._units,
                align: 'center',
                style: {
                    color: 'black',
                    fontWeight: 'bold',
                }
            }
        })
    }
    if(setTicks == true){
        chart.yAxis[0].update({
            tickPositioner: function () {
                var positions = [];
                tick = Math.floor(extremes.dataMin)-2;
                if(maxY > -9999){
                    max = maxY+2;
                }else{
                    max = extremes.dataMax+2;
                }
                increment = 1;
                if((max-tick)>20) increment = 2;
                for (tick; tick - increment <= max; tick += increment) {
                    positions.push(tick);
                }
                return positions
            }
        });
    }
}



function addNWSRender(graphId){
    var chart = $('#'+graphId).highcharts();
    nowP = chart.xAxis[0].toPixels(new Date().getTime())
    extX = chart.xAxis[0].getExtremes();
    extY = chart.yAxis[0].getExtremes();
    xmaxP = chart.xAxis[0].toPixels(extX.max);
    xminP = chart.xAxis[0].toPixels(extX.min);
    ymaxP = chart.yAxis[0].toPixels(extY.max);
    chart.renderer.path(['M', xminP+10, ymaxP-10, 'L', nowP-10, ymaxP-10])
        .attr({
            'stroke-width': 3,
            stroke: 'grey',
            class: 'nwsRender',
            zIndex: 3
        }).add();
    chart.renderer.path(['M',nowP+10,ymaxP-10,'L',xmaxP-10,ymaxP-10])
        .attr({
            'stroke-width': 3,
            stroke: 'blue',
            class: 'nwsRender',
            zIndex: 3
        }).add()
    text = chart.renderer.text(
        'Observed',
        ((nowP+xminP)/2) -30,
        ymaxP-5
        ).attr({
            zIndex: 5,
            class: 'nwsRender'
        }).css({
            color: 'grey',
            fontSize: '16px'
        }).add(),
    box = text.getBBox();
    chart.renderer.rect(box.x - 5, box.y, box.width + 10,box.height-3)
        .attr({
            fill: 'white',
            stroke: 'white',
            class: 'nwsRender',
            zIndex: 4
        })
    .add();
    text = chart.renderer.text(
        'Forecast',
        ((nowP+xmaxP)/2) -30,
            ymaxP-5
        ).attr({
            zIndex: 5,
            class: 'nwsRender'
        }).css({
            color: 'blue',
            fontSize: '16px'
    }).add(),
    box = text.getBBox();
    chart.renderer.rect(box.x - 5, box.y, box.width + 10, box.height-3)
        .attr({
            fill: 'white',
            stroke: 'white',
            class: 'nwsRender',
            zIndex: 4
        })
        .add();
    var point;

    try{
        point = chart.get('nwsObserved').data[chart.get('nwsObserved').data.length-1];
        text = chart.renderer.text(
            'Current Level: '+point.y+' ft',
            point.plotX + chart.plotLeft - 130,
            point.plotY + chart.plotTop - 15
            ).css({
            fontSize: '12px',
            fontWeight: 'bold'
            }).attr({
            zIndex: 10,
            class: 'nwsRender'
        }).add();
        text = chart.renderer.text(
            'Latest Observed Value: '+point.y+' ft at '+Highcharts.dateFormat('%l %P %b %e',point.x),
            chart.plotLeft+10,
            chart.plotTop+15
            ).attr({
                zIndex: 10,
                class: 'nwsRender'
            }).css({
                color: 'black',
                width:  '550px',
                fontSize: '12px'
            }).add();
        box = text.getBBox();
        chart.renderer.rect(box.x - 5, box.y - 1, box.width + 10, box.height + 1, 5)
           .attr({
               fill: 'white',
               stroke: 'rgba(255,255,0,1)',
               zIndex: 9,
               class: 'nwsRender'
           }).add();

    }
    catch(e){
    }
}



// Proof of concept for AJAX usage with instantaneous values service
$('#showFloodStages').change(function() {
    $(".nwsRender").remove();
    var chart = $('#stagegraph').highcharts();
    nwsLid = chart.NWSid;

    if($(this).is(':checked')){
        addNWSBands('stagegraph',AHPSjson,true,'band',true);
    }else{
        $(".nwsLegend").remove();
        $("#removeLegend").attr('value', 'Add Flood Stages');
        chart.yAxis[0].removePlotBand('plotBand');
        chart.yAxis[0].removePlotLine('plotLine');
        extremes = chart.yAxis[0].getExtremes();

        chart.yAxis[0].update({
            tickPositioner: function () {
                var positions = []
                tick = Math.floor(extremes.dataMin)-2
                max = extremes.dataMax+2
                increment = 1
                if((max-tick)>20) increment = 2
                for (tick; tick - increment <= max; tick += increment) {
                    positions.push(tick);
                }
                return positions
            }
        });
    }
    addNWSRender('stagegraph');
});

$('#showFloodStagesRating').change(function() {
    var chart = $('#ratinggraph').highcharts();
        nwsLid = chart.NWSid;

        if($(this).is(':checked')){
            addNWSBands('ratinggraph',AHPSjson,false,'line',false);
        }else{
            chart.yAxis[0].removePlotLine('plotLine');
        }
});

function plotRating(usgsSite,ahps){

    $.ajax({
        url: "rdbajax.php?site="+usgsSite+"&type=rating",
        dataType: 'json',
        data: '',
        async: false,
        success: function(json){
            if(json.error_info.error == 0){
                NWS.ratingsSeries.push(ratingJSON2HC(json));
                //console.log(NWS.ratingsSeries);
                graphRating('ratinggraph',NWS,usgsSite,ahps);
                addMeasureQ_Rating('ratinggraph',usgsSite);
            }

        }
    });
}


function swapAxis(allSeries){
        var tempX;
        $.each(allSeries, function(){
            var swappedData = [];
            var object = false;
            $.each(this.data, function(){
                if($.isArray(this)){
                    swappedData.push([this[1],this[0]]);
                }else{
                    object = true;
                    tempX = this.x;
                    this.x = this.y;
                    this.y = tempX;
                    swappedData.push(this);
                }
            });

            if(object){
                swappedData.sort(function(a, b) {
                    return parseFloat(a.x) - parseFloat(b.x);
                });
            }
            this.data = swappedData;
        });
        return allSeries;
}

function plotHeatQ(usgsSite){

    //Load USGS Rating Curve
    $.ajax({
        url: "http://waterservices.usgs.gov/nwis/dv/?format=json,1.1&indent=on&sites=" + usgsSite + "&parameterCd=00060&startDT=1800-01-01&endDT=2100-01-19",
        dataType: 'json',
        data: '',
        success: function(json){
            if(json.value.timeSeries.length>0){
                NWS.dailyUSGS.push({
                    data: USGSDailytoHCHeat(json,"00060"),
                    name:'USGS Daily Data',
                    zIndex:2,
                    nwsType: 'observed'
                });
                NWS.usgsTitle = json.value.timeSeries[0].sourceInfo.siteName;
                graphHeatQ(NWS);

            }
        },
        error : function(XMLHttpRequest, textStatus, errorThrown) {
            $('#discharge').val('');
            $('#date').val('');
        }
    });

}



$('#query').click(function() {
    loadPage($('#site').val());
});

$('#togglePeakLabels').click(function(){
    // Toggle data labels
    var chart = $('#dischargegraph').highcharts();
    series = chart.get('annualPeakYear');
    var opt = series.options;
    var newOption = !opt.dataLabels.enabled;

    series.update({
        dataLabels: {
            enabled: newOption
            }
    });
    series = chart.get('annualPeaks');
    var opt = series.options;
    var newOption = !opt.dataLabels.enabled;

    series.update({
        dataLabels: {
            enabled: newOption
            }
    });
});


$('#addFFlines').change(function() {
  if($(this).is(':checked')){
        addPeakFlow('dischargegraph');
    }
    else
    {
      $('#dischargegraph').highcharts().yAxis[0].removePlotBand('ffline2016');
  }
});

$('#addFFlines2003').change(function() {
  if($(this).is(':checked')){
        addPeakFlow('dischargegraph','2003');
    }
    else
    {
      $('#dischargegraph').highcharts().yAxis[0].removePlotBand('ffline2003');
  }
});

$('#loadAnnual').click(function(){
    var year = new Date().getFullYear();
    $('#dischargeStart').val(year+'-01-01');
    $('#dischargeEnd').val(year+'-12-31');

    $( "#loadQ" ).trigger( "click" );

});


$('#zoomToStage').click(function(){
    var stageChart = $('#stagegraph').highcharts();
    extremes = stageChart.xAxis[0].getExtremes();
    var dischargeChart = $('#dischargegraph').highcharts();
    dischargeChart.xAxis[0].setExtremes(extremes.min, extremes.max);
    dischargeChart.showResetZoom();
});

$('#shefEncodeForecast').click(function(){
    var chart = $('#stagegraph').highcharts();
    var forecastSeries = chart.get('nwsStageForecast');

    $('#shefText').html(shefEncode(forecastSeries).replace(/(?:\r\n|\r|\n)/g, '<br />'));
});

$('#shefEncodeObserved').click(function(){
    var chart = $('#stagegraph').highcharts();
    var forecastSeries = chart.get('nwsStageObserved');

    $('#shefText').html(shefEncode(forecastSeries,true).replace(/(?:\r\n|\r|\n)/g, '<br />'));
});

$('#loadQ').click(function(){

    var chart = $('#dischargegraph').highcharts();
    var nwsLid = chart.options.nwsLid;
    var usgsID = chart.options.usgsID;
    chart.destroy;
    graphDischarge('dischargegraph',Date.parse($('#dischargeStart').val()),Date.parse($('#dischargeEnd').val()),usgsID,nwsLid);
    addStats('dischargegraph');
    if(document.getElementById('getIv').checked) addUSGS('dischargegraph','discharge','iv');
    if(document.getElementById('getDv').checked) addUSGS('dischargegraph','discharge','dv');
    addAHPS('dischargegraph','discharge');
    addAnnualPeaks('dischargegraph',state);
    addMeasureQ_Rating('dischargegraph',null,"series");
    if($('#addFFlines').is(':checked')){
        addPeakFlow('dischargegraph');
    }

});

function getBothIds(site){
    var nwsLid = '';
    var usgsID;
    if(site.length<=5){
        nwsLid = site.toLowerCase();
        usgsID = crossWalkTable[nwsLid];
    }
    else{
        usgsID = site;
         $.each(crossWalkTable,function(key,value){
            if(value == usgsID){
                nwsLid = key;
                return false;
            }
         });
    }
    return {
        nws:nwsLid,
        usgs:usgsID
        }
}

function isInteger(x) {
        return x % 1 === 0;
    }

$('#loadComparison').click(function(){
    var text  = $('#comparisonSite').val();

    if (isInteger(text)){
        addAnnualData('dischargegraph','iv',text);
        addAnnualData('dischargegraph','dv',text);
    }
    else{
        var id = getBothIds($('#comparisonSite').val());
        if(document.getElementById('getIv').checked) addUSGS('dischargegraph','discharge','iv',id.usgs);
        if(document.getElementById('getDv').checked) addUSGS('dischargegraph','discharge','dv',id.usgs);
    }
});


var Area = 0;

function loadPage(site){


    var year = new Date().getFullYear();
    $('#dischargeStart').val(year+'-01-01');
    $('#dischargeEnd').val(year+'-12-31');
    initializeNWS();
    var siteId = getBothIds(site);
    //Load USGS Site Information
    $.ajax({
        url: "http://waterservices.usgs.gov/nwis/site/?format=rdb,1.0&sites="+siteId.usgs+"&siteOutput=expanded",
        dataType: 'text',
        data: '',
        async: false,
        success: function(data){
            var siteInfo = getRDBSiteInfo(data);
            state = FIPSCODES[siteInfo.state_cd].toLowerCase();
            $('#watershedArea').val(siteInfo.drain_area_va);
            Area = siteInfo.drain_area_va;
            Highcharts.setOptions({
                title: {
                    text:siteInfo.station_nm
                }
            });
        }
    });


    //Setup Stage and Discharge Graphs with AHPS data
    graphStage('stagegraph',new Date().getTime()-3600000*24*7,new Date().getTime()+3600000*24*4,siteId.usgs,siteId.nws);
    addAHPS('stagegraph','stage');
    if($('#showFloodStages').is(':checked')){
        addNWSBands('stagegraph',AHPSjson,true,'band',true);
        addNWSRender('stagegraph');
    }

    //Setup Discharge Graph
    graphDischarge('dischargegraph',Date.parse($('#dischargeStart').val()),Date.parse($('#dischargeEnd').val()),siteId.usgs,siteId.nws);
    addAHPS('dischargegraph','discharge');

    if(siteId.usgs == '') return;
    plotHeatQ(siteId.usgs);
    plotRating(siteId.usgs,siteId.nws);

    addUSGS('stagegraph','stage','iv');

    addStats('dischargegraph');
    if(document.getElementById('getIv').checked) addUSGS('dischargegraph','discharge','iv');
    if(document.getElementById('getDv').checked) addUSGS('dischargegraph','discharge','dv');
    addAnnualPeaks('dischargegraph',state);
    addMeasureQ_Rating('dischargegraph',null,"series");
    if($('#addFFlines').is(':checked')){
        addPeakFlow('dischargegraph');
    }
    var chart = $('#ratinggraph').highcharts();
    if(chart != undefined){
        var nwsLid = chart.options.nwsLid;
        if($('#showFloodStagesRating').is(':checked')){
            addNWSBands('ratinggraph',AHPSjson,false,'line',false);
        }
    }
    //graphAnnual('annualDischarge',siteId.usgs,siteId.nws);
    //addAnnualData('annualDischarge','iv');

}


function graphStage(container,minDate,maxDate,usgs,nws){
    var title;
    if(NWS.usgsTitle.length>0){
        title = NWS.usgsTitle;
    }else{
      title = NWS.nwsTitle;
    }

    stagechartobj= {
        usgsID:usgs,
        nwsLid:nws,
        credits: {
            enabled: false
        },
        chart: {
            renderTo: container,
            zoomType: 'xy',
            marginTop: 80,
            marginBottom:175,
            marginLeft:80,
            events: {
                selection: selectPointsByDrag,
            },
        },

        xAxis: {
            max : maxDate,
            min : minDate,
            type: 'datetime',
            tickPixelInterval: 25,
            gridLineColor: "#E8E8E8",
            gridLineWidth: 1,
            labels: {
                step: 2,
                staggerLines: 1,
                formatter: function () {
                    return Highcharts.dateFormat('%l %P<br>%b %e',this.value)
                }
            },
            plotLines: [{
                color: 'black', // Color value
                dashStyle: 'dot', // Style of the plot line. Default to solid
                value: new Date().getTime(), // Value of where the line will appear
                width: '2', // Width of the line
                zIndex:4
            }],
            plotBands: [{
                from: 0,
                to: new Date().getTime(),
                color: 'rgba(248,248,248,0.4)',
                zIndex:2,
                id: 'plot-band-observed'
            }]
        },
        yAxis: [{
            allowDecimals: false,
            title: {
                text: 'River Stage (ft)',
                style: {
                    color: 'Black',
                    fontWeight: 'bold',
                    fontSize: '14px'
                }
            },
            labels:{
                x: -5
            },

        }],
        tooltip: {
            valueSuffix: ' ft',
            shared: false,
            zIndex: 11,
            //headerFormat: '<span style="font-size: 14px">'+moment({point.key})format('MMM D, YYYY HH:mm')+'</span><br/>',
            headerFormat: '<span style="font-size: 12px;font-weight: bold;">{point.key:%Y-%m-%d %H:%M}</span><br/>',
            positioner: function () {
                    return { x: 375, y: 350 };
             },

        },
        plotOptions:{
            series:{
                stickyTracking : false,
                turboThreshold: 0,
                point:{
                    events:{


                        drop:function(){

                            if(this.series.options.id == 'nwsStageForecast'){
                                var dischargeChart = $('#dischargegraph').highcharts();
                                var forecast = dischargeChart.get('nwsDischargeForecast').points;
                                for(var y = 0;y< this.series.data.length; y++){
                                    var newY = parseFloat(this.series.data[y].y.toFixed(2));
                                    var newDischarge = ratingLookup(ratingchart.get('curve').data,newY,'stage');
                                    this.series.data[y].update({y:newY});
                                    for (var i = 0; i < forecast.length; i++) {
                                        if (forecast[i].x == this.series.data[y].x){
                                            forecast[i].update({y:parseInt(newDischarge)});
                                            break;
                                        }
                                    }
                                }
                            }

                            var extremes = this.series.yAxis.getExtremes();
                            var max = extremes.max;
                            var min = extremes.min;
                            if(extremes.dataMax > extremes.max-2) max = extremes.max + 4;
                            if(extremes.dataMin < extremes.min+2) min = extremes.min - 4;

                            var chart = this.series.chart;
                            var positions = chart.yAxis[0].tickPositions;
                            var interval = positions[1]-positions[0];
                            if(extremes.dataMax > extremes.max-3){
                                var last = positions[positions.length-1];
                                positions.push(last+interval,last+interval*2,last+interval*3);
                            }
                            chart.yAxis[0].update({
                                tickPositioner: function () {
                                    var positions = [];
                                    var tick = Math.floor(min);
                                    increment = 1;
                                    if((max-tick)>20) increment = 2;
                                    for (tick; tick - increment < max; tick += increment) {
                                        positions.push(tick);
                                    }
                                    return positions
                                }
                            });
                       }
                    }
                 }
            }
        },
        legend: {
            align: 'center',
            verticalAlign: 'bottom',
            borderWidth: 0,
            y:-100,
            x:25
        },
        series : [{data:[null,null],
                    showInLegend:false}]

    }
  chart = new Highcharts.Chart(stagechartobj);
}

function graphDischarge(container,minDate,maxDate,usgs,nws){
    ////////////////////////////////////Discharge Graph////////////////////////////////
    var first_line = true;
    var xMin;
    var xMax;


    dischargechartobj= {
        credits: {
            enabled: false
        },
        usgsID: usgs,
        nwsLid:nws,
        chart: {
            renderTo: container,
            zoomType: 'xy',
            marginTop: 40,
            marginBottom:100,
            marginLeft:80,
        },
        plotOptions:{
            series:{
                stickyTracking : false,
                turboThreshold: 0,
                point: {
                    events: {
                        click: function() {
                            chart = this.series.chart;
                            if($("input[name=Qfunction]:checked").val() == 'base'){
                                if(this.series.userOptions.calcVol  == true){
                                    if(first_line){
                                        $(".baseFlowLabel").remove();
                                        if(chart.get('baseFlow')) chart.get('baseFlow').remove();
                                        xMin = this.x;
                                        first_line = false;
                                        chart.xAxis[0].addPlotLine({
                                            value: this.x,
                                            color: 'red',
                                            width: 1,
                                            id: 'vert_1',
                                            zIndex:5
                                        });
                                    }
                                    else{
                                        first_line = true;
                                        if(chart.get('baseFlow')) chart.get('baseFlow').remove();
                                        chart.xAxis[0].removePlotLine('vert_1');
                                        xMax = this.x;
                                        series = this.series;
                                        var baseVolume = addBaseFlowSeries(chart,series,xMin,xMax);
                                        var totalVolume = volumeUnderCurve(series,xMin,xMax);
                                        var baseVolume = volumeUnderCurve(chart.get('baseFlow'));
                                        var baseVolumeIn = baseVolume/(Area*640)*12;
                                        var totalVolumeIn =totalVolume/(Area*640)*12;
                                        series = chart.get('baseFlow');
                                        var slope = (series.data[1].y-series.data[0].y)/((series.data[1].x-series.data[0].x)/1000)*3600*24;
                                        var len = ((series.data[1].x-series.data[0].x)/1000)/(3600*24);
                                        var diff = (series.data[1].y-series.data[0].y);

                                        labelText = '<br>Total  Volume: '+totalVolumeIn.toFixed(2)+'in   '+totalVolume.toFixed(0)+' ac-ft<br>'+'Baseflow Volume: '+baseVolumeIn.toFixed(2)+'in   '+baseVolume.toFixed(0)+' ac-ft<br>Peak Vol: '+(totalVolumeIn-baseVolumeIn).toFixed(2)+'in   '+(totalVolume-baseVolume).toFixed(2)+' ac-ft<br>Slope: '+Math.round(slope)+' cfs change per day<br>Duration: '+len.toFixed(1)+' days<br>Delta: '+Math.round(diff)+' cfs'
                                        textBox = chart.renderer.label(labelText, 10, 80)
                                            .attr({
                                                fill: 'rgba(255, 255, 255,1)',
                                                padding: 8,
                                                r: 5,
                                                zIndex: 100,
                                                class: 'baseFlowLabel',
                                                'stroke-width':2,
                                                stroke: 'black'
                                             })
                                             .add();
                                        removeBox = chart.renderer.label('<center>Click to<br> Remove</center>', 10, 40)
                                            .attr({
                                                fill: 'rgba(255, 255, 255,1)',
                                                padding: 1,
                                                zIndex: 100,
                                                class: 'baseFlowLabel',
                                                'stroke-width':2,
                                                r:5,
                                                stroke: 'black'
                                             })
                                             .on('click', function () {
                                                textBox.destroy();
                                                removeBox.destroy();
                                                if(chart.get('baseFlow')) chart.get('baseFlow').remove();
                                             })
                                            .add();
                                    }
                                }

                                else{
                                    addAnnualData(container,'iv',this.year);
                                    addAnnualData(container,'dv',this.year);
                                }
                            }
                        },
                        mouseOver: function() {
                            ratingchart.xAxis[0].removePlotLine('vert_loc');
                            ratingchart.yAxis[0].removePlotLine('horz_loc');
                            ratingchart.xAxis[0].addPlotLine({
                                value: this.y,
                                color: 'red',
                                width: 2,
                                id: 'vert_loc',
                                zIndex:100

                            });
                            ratingchart.yAxis[0].addPlotLine({
                                value: ratingLookup(ratingchart.get('curve').data,this.y),
                                color: 'red',
                                width: 2,
                                id: 'horz_loc',
                                label: {
                                    text: ratingLookup(ratingchart.get('curve').data,this.y),
                                    align: 'center',
                                    style: {
                                        fontWeight: 'bold',
                                        backgroundColor: 'white'
                                    },
                                    y:-2,
                                    zIndex:100
                                }

                            });
                        },
                        mouseOut: function() {
                            ratingchart.xAxis[0].removePlotLine('vert_loc');
                            ratingchart.yAxis[0].removePlotLine('horz_loc');
                        },
                        drop: function(){
                            if(this.series.options.id == 'nwsDischargeForecast'){
                                var stageChart = $('#stagegraph').highcharts();
                                var forecast = stageChart.get('nwsStageForecast').points;
                                for(var y =0; y< this.series.data.length;y++){
                                    var newY = parseInt(this.series.data[y].y);
                                    var stage = ratingLookup(ratingchart.get('curve').data,newY);
                                    this.series.data[y].update({y:newY});
                                    for (var i = 0; i < forecast.length; i++) {
                                        if (forecast[i].x == this.series.data[y].x){
                                            forecast[i].update({y:parseFloat(stage.toFixed(2))});
                                            break;
                                        }
                                    }
                                }
                             }
                        }
                    }
                }
            }
       },

        xAxis: {
            max:maxDate,
            min:minDate,
            type: 'datetime',
            //tickPixelInterval: 25,
            gridLineColor: "#E8E8E8",
            gridLineWidth: 1,
            labels: {
                step: 2,
                staggerLines: 1,
                //formatter: function () {
                //    return Highcharts.dateFormat('%l %P<br>%b %e',this.value)
                //}
            },
            plotLines: [{
                color: 'black', // Color value
                dashStyle: 'dot', // Style of the plot line. Default to solid
                value: new Date().getTime(), // Value of where the line will appear
                width: '2', // Width of the line
                zIndex:2
            }],
        },
        yAxis: [{
            title: {
                text: 'River Discharge (cfs)',
                style: {
                    color: 'Black',
                    fontWeight: 'bold',
                    fontSize: '14px'
                }
            },
            labels:{
                x: -5
            },
            type: 'linear',
            floor:0

        }],
        tooltip: {
            valueSuffix: ' cfs',
            shared: false,
            crosshairs: true,
            headerFormat: '<span style="font-size: 12px;font-weight: bold;">{point.key:%Y-%m-%d %H:%M}</span><br/>',
            positioner: function () {
                    return { x: 100, y: 28 };
             }
        },
        legend: {
          align: 'center',
          verticalAlign: 'bottom',
          borderWidth: 0,
          x:10
        },
        series : [{data:[null,null],
                    visible:false,
                    showInLegend:false}]
    }

    new Highcharts.Chart(dischargechartobj);
  }




function graphRating(container,NWS,usgs,nws){
    ////////////////////////////////////Rating Graph////////////////////////////////

    ratingchartobj= {
      credits: {
          enabled: false
        },

        chart: {
          renderTo: container,
          zoomType: 'xy',
          marginTop: 50,
          marginBottom:100,
          marginLeft:80,
          custom:'regular',
          usgsID: usgs,
          nwsLid:nws,
      },
        xAxis: {
            type: 'logarithmic',
            crosshair: {
                width: 1,
                snap:false,
                color: 'red'
            },
            type: 'linear',
            title: {
                text: 'River Discharge (ft)',
                style: {
                    color: 'Black',
                    fontWeight: 'bold',
                    fontSize: '14px'
                }
            },
        },
        yAxis: [{
            crosshair: {
                width: 1,
                color: 'red'
            },
            title: {
                text: 'River Stage (ft)',
                style: {
                    color: 'Black',
                    fontWeight: 'bold',
                    fontSize: '14px'
                }
            },
            labels:{
                x: -5
            },
            type: 'linear'
        }],
        tooltip: {
            headerFormat: 'Rating Curve<br>',
            zIndex:10,
            positioner: function () {
                    return { x: 20, y: 20 };
                }
        },
        legend: {
            align: 'center',
            verticalAlign: 'bottom',
            borderWidth: 0,
            x:10
        },
        series: NWS.ratingsSeries
    }
    ratingchart = new Highcharts.Chart(ratingchartobj);
    text = ratingchart.renderer.text(
                '<span style="color:red">Most Recent Measurement</span><br><span style="color:orange">Measurements in the Last Year</span><br><span style="color:rgba(0,0,205,0.8)">Newer -</span><span style="color:rgba(0,0,205,0.3)"> Older Measurements</span>',
                550,
                400
            ).attr({
                zIndex: 5
            }).css({
                color: 'black',
                'text-align': 'center',
                'font-weight': 'bold',
                width:  400,
                fontSize: '13px'
            }).add(),
            box = text.getBBox();

        ratingchart.renderer.rect(box.x - 5, box.y - 5, box.width + 10, box.height + 10, 5)
            .attr({
                fill: 'white',
                stroke: 'gray',
                'stroke-width': 1,
                zIndex: 4
            })
            .add();

    //This was added to zoom to the current rating curve, helps when bad/old data skews the extents of graph
    var points=ratingchart.series[0].points;
    var ymin=points[0].y;
    var ymax=points[points.length-1].y+1;
    ratingchart.yAxis[0].setExtremes(ymin,ymax);
    ratingchart.showResetZoom();

}



$('#dischargeAxis').change(function() {
  if($(this).is(':checked')){
    $('#dischargegraph').highcharts().yAxis[0].update({ type: 'logarithmic'});
    }
    else
    {
      $('#dischargegraph').highcharts().yAxis[0].update({ type: 'linear'});
  }
});

$('#ratingLog').change(function() {
  if($(this).is(':checked')){
        $('#ratinggraph').highcharts().yAxis[0].update({ type: 'logarithmic'});
        $('#ratinggraph').highcharts().xAxis[0].update({ type: 'logarithmic'});
    }
    else
    {
        $('#ratinggraph').highcharts().yAxis[0].update({ type: 'linear'});
        $('#ratinggraph').highcharts().xAxis[0].update({ type: 'linear'});
  }
});


function graphHeatQ(NWS){
    var title;
    if(NWS.usgsTitle.length>0){
        title = NWS.usgsTitle;
    }else{
      title = NWS.nwsTitle;
    }

    var start;
    heatchartobj= {
        chart: {
            renderTo: 'heatMapQ',
            type: 'heatmap',
            zoomType: 'xy',

        },
        credits: {
            enabled: false
        },
        title: {
            text: title+' DAILY DATA'
        },
        plotOptions:{
            series:{
                point: {
                    events: {
                        mouseOver: function() {
                            ratingchart.xAxis[0].removePlotLine('vert_loc');
                            ratingchart.yAxis[0].removePlotLine('horz_loc');
                            ratingchart.xAxis[0].addPlotLine({
                                value: this.value,
                                color: 'red',
                                width: 1,
                                id: 'vert_loc'
                            });
                            ratingchart.yAxis[0].addPlotLine({
                                value: ratingLookup(ratingchart.get('curve').data,this.value),
                                color: 'red',
                                width: 1,
                                id: 'horz_loc'
                            });
                        },
                        mouseOut: function() {
                            ratingchart.xAxis[0].removePlotLine('vert_loc');
                            ratingchart.yAxis[0].removePlotLine('horz_loc');
                        }

                    }
                }
            }
       },

       xAxis: {
            title: {
                text: 'Day of Year'
            },
            min: 0,
            max: 365,
            tickPositions: [1,32, 60,91, 121,152, 182,213, 244,274,305,335],
            labels: {
                align: 'left',
                x: 5,
                y: 14,
                formatter: function (){

                    return $.datepicker.formatDate(' M ',dateFromDay('2015',this.value));
                 }
            },
            showLastLabel: true,
            tickLength: 10
        },

        yAxis: {
            title: {
                text: 'Year'
            },
            minPadding: 0,
            maxPadding: 0,
        },

        colorAxis: {
            type: 'logarithmic',
            stops: [
                [0 ,   '#FF0000'],
                [0.3, '#FFCC33'],
                [0.8, '#66CCFF'],
                [1 ,   '#3300CC']
            ],
            startOnTick: false,
            endOnTick: false
        },
        tooltip: {
            headerFormat: 'Daily Discharge<br>',
            formatter: function (){
                return '<b>' + $.datepicker.formatDate('M d yy',dateFromDay(this.point.y,this.point.x))+' - '+numberWithCommas(this.point.value) + ' cfs </b>';
            },
            positioner: function () {
                    return { x: 500, y: 28 };
             }
        },
        series: [{
            data: NWS.dailyUSGS[0].data,
            borderWidth: 0,
            nullColor: '#EFEFEF',
            turboThreshold: Number.MAX_VALUE // #3404, remove after 4.0.5 release
        }]

    }


    heatchart = new Highcharts.Chart(heatchartobj);

}

    /**
     * Display a temporary label on the chart
     */
    function toast(chart, text) {
        chart.toast = chart.renderer.label(text, 100, 120)
            .attr({
                fill: Highcharts.getOptions().colors[0],
                padding: 10,
                r: 5,
                zIndex: 8
            })
            .css({
                color: '#FFFFFF'
            })
            .add();

        setTimeout(function () {
            chart.toast.fadeOut();
        }, 2000);
        setTimeout(function () {
            chart.toast = chart.toast.destroy();
        }, 2500);
    }

    /**
     * Custom selection handler that selects points and cancels the default zoom behaviour
     */
    function selectPointsByDrag(e) {
        if($("input[name=stageDrag]:checked").val() == 'zoom'){
            return true;
        }

        // Select points
        Highcharts.each(this.series, function (series) {
            Highcharts.each(series.points, function (point) {
                if (point.x >= e.xAxis[0].min && point.x <= e.xAxis[0].max &&
                        point.y >= e.yAxis[0].min && point.y <= e.yAxis[0].max) {
                    //point.select(true, true);
                    if (point.series.visible === true) point.update([point.x,null]);

                }
            });
        });

        // Fire a custom event
       // Highcharts.fireEvent(this, 'selectedpoints', { points: this.getSelectedPoints() });
        chart.redraw();
        return false; // Don't zoom
    }

    /**
     * The handler for a custom event, fired from selection event
     */
    function selectedPoints(e) {
        // Show a label
        toast(this, '<b>' + e.points.length + ' points selected.</b>' +
            '<br>Click on empty space to deselect.');
    }

    /**
     * On click, unselect all points
     */
    function unselectByClick() {
        var points = this.getSelectedPoints();
        if (points.length > 0) {
            Highcharts.each(points, function (point) {
                point.select(false);
            });
        }
    }



$(function () {


    Highcharts.setOptions({
        title: {
                text:'test'
        },
        global: {
            useUTC: false,

        },
        lang: {
            thousandsSep: ','
         },
         tooltip: {
            backgroundColor : 'rgba(255, 255, 255, 1)',
         }

    });

    $('#dischargeStart').val(Highcharts.dateFormat('%Y-%m-%d',new Date().getTime()-3600000*24*30));
    $('#dischargeEnd').val(Highcharts.dateFormat('%Y-%m-%d',new Date().getTime()+3600000*24*4));

    site = getParameterByName('site');
    $('#site').val(site);

    //Load USGS to NWSLID Cross Walk Table
    $.ajax({
        type: 'GET',
          url: 'crossWalk.json',
          dataType: 'json',
          success: function(data) {
            crossWalkTable = data;
            },
          async: false,
          error : function(XMLHttpRequest, textStatus, errorThrown) {
                alert('error getting crosswalk table');

            }
    });
    $.ajax({
        type: 'GET',
          url: 'FIPS.json',
          dataType: 'json',
          success: function(data) {
            FIPSCODES = data;
            },
          async: false,
          error : function(XMLHttpRequest, textStatus, errorThrown) {
                alert('error getting fips codes');

            }
    });

    if(site != null){
        loadPage(site);
    }
    $(document).keydown(function(e) {

        var hours = 24;
        var shift = false;
        if(e.keyCode == 39 && e.shiftKey){
            hours = 24
            if(e.ctrlKey) hours = 1
            shift = true;
        }
        if(e.keyCode == 37 && e.shiftKey){
            hours = -24
            if(e.ctrlKey) hours = -1
            shift = true;
        }
        if(shift){
            var chart = $('#dischargegraph').highcharts();

            var length=chart.series.length
            for (var z = 0; z < length; z++){
                if(chart.series[z].options.timeShift != true) continue;
                if(chart.series[z].visible != true) continue;
                series = chart.series[z];
                series.options.dateShift = series.options.dateShift+(hours*3600*1000)
                var xData = series.xData;
                var yData = series.yData;
                var shiftData = [];
                for(i=0;i<xData.length;i++){
                    if(typeof xData[i] == 'undefined') continue;
                    date = moment(xData[i]).add(hours, 'hours');
                    shiftData.push([date.valueOf(),yData[i]]);
                }
                series.setData(shiftData);
            }
        }
    });


});

</script>
</body>
</html>

